{% extends 'base/base.html' %}

{% block title %}Edit {{ employee.get_full_name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Edit {{ employee.get_full_name }}</h1>
            <p class="text-gray-600 mt-2">Update employee information</p>
        </div>
        <div class="flex space-x-3">
            <a href="{% url 'users:employee_detail' employee.id %}" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Back to Details
            </a>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow">
            <form method="post" class="p-6 space-y-6">
                {% csrf_token %}
                
                <!-- Basic Information -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Basic Information</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="first_name" class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                            <input type="text" id="first_name" name="first_name" required
                                   value="{{ employee.first_name }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="last_name" class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                            <input type="text" id="last_name" name="last_name" required
                                   value="{{ employee.last_name }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                            <input type="email" id="email" name="email" required
                                   value="{{ employee.email }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                            <input type="text" id="username" name="username" readonly
                                   value="{{ employee.username }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600">
                            <p class="text-xs text-gray-500 mt-1">Username cannot be changed</p>
                        </div>
                    </div>
                </div>

                <!-- Role and Status -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Role and Status</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {% if user.role == 'COMPANY_MANAGER' %}
                        <div>
                            <label for="role" class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                            <select id="role" name="role" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                {% for role_key, role_name in roles %}
                                <option value="{{ role_key }}" {% if role_key == employee.role %}selected{% endif %}>
                                    {{ role_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% else %}
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                            <input type="text" readonly
                                   value="{{ employee.get_role_display }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600">
                            <p class="text-xs text-gray-500 mt-1">Only company managers can change roles</p>
                        </div>
                        {% endif %}
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Account Status</label>
                            <div class="flex items-center">
                                <input type="checkbox" id="is_active" name="is_active" 
                                       {% if employee.is_active %}checked{% endif %}
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="is_active" class="ml-2 block text-sm text-gray-900">
                                    Active Employee
                                </label>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Inactive employees cannot log in or check attendance</p>
                        </div>
                    </div>
                </div>

                <!-- Current Department -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Current Department</h2>
                    {% if current_department %}
                        <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-building text-blue-400"></i>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-blue-800">{{ current_department.name }}</h3>
                                    <p class="text-sm text-blue-600">{{ current_department.branch.name }}</p>
                                </div>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">
                            To change department assignments, use the 
                            <a href="{% url 'users:department_management' %}" class="text-blue-600 hover:text-blue-800">Department Management</a> 
                            page.
                        </p>
                    {% else %}
                        <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-yellow-800">No Department Assignment</h3>
                                    <p class="text-sm text-yellow-700 mt-1">
                                        This employee is not assigned to any department. 
                                        <a href="{% url 'users:department_management' %}" class="text-yellow-800 underline">Assign them to a department</a>.
                                    </p>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- Profile Information -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Profile Information</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="bio" class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                            <textarea id="bio" name="bio" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                      placeholder="Brief description about the employee">{% if employee.profile %}{{ employee.profile.bio }}{% endif %}</textarea>
                        </div>
                        <div>
                            <label for="address" class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                            <textarea id="address" name="address" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                      placeholder="Home address">{% if employee.profile %}{{ employee.profile.address }}{% endif %}</textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="emergency_contact_name" class="block text-sm font-medium text-gray-700 mb-2">Emergency Contact Name</label>
                                <input type="text" id="emergency_contact_name" name="emergency_contact_name"
                                       value="{% if employee.profile %}{{ employee.profile.emergency_contact_name }}{% endif %}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="Emergency contact name">
                            </div>
                            <div>
                                <label for="emergency_contact_phone" class="block text-sm font-medium text-gray-700 mb-2">Emergency Contact Phone</label>
                                <input type="tel" id="emergency_contact_phone" name="emergency_contact_phone"
                                       value="{% if employee.profile %}{{ employee.profile.emergency_contact_phone }}{% endif %}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="Emergency contact phone">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Account Information -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Account Information</h2>
                    <div class="bg-gray-50 rounded-md p-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="font-medium text-gray-700">Date Joined:</span>
                                <span class="text-gray-900">{{ employee.date_joined|date:"M d, Y" }}</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">Last Login:</span>
                                <span class="text-gray-900">
                                    {% if employee.last_login %}
                                        {{ employee.last_login|date:"M d, Y H:i" }}
                                    {% else %}
                                        Never
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                    <a href="{% url 'users:employee_detail' employee.id %}" 
                       class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-lg font-medium transition-colors">
                        Cancel
                    </a>
                    <button type="submit" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const emailInput = document.getElementById('email');

    // Email validation
    emailInput.addEventListener('blur', function() {
        const email = this.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (email && !emailRegex.test(email)) {
            this.setCustomValidity('Please enter a valid email address');
        } else {
            this.setCustomValidity('');
        }
    });

    // Form submission confirmation
    form.addEventListener('submit', function(e) {
        const requiredFields = ['first_name', 'last_name', 'email'];
        let isValid = true;

        requiredFields.forEach(fieldName => {
            const field = document.getElementById(fieldName);
            if (!field.value.trim()) {
                field.setCustomValidity('This field is required');
                isValid = false;
            } else {
                field.setCustomValidity('');
            }
        });

        if (!isValid) {
            e.preventDefault();
            alert('Please fill in all required fields correctly.');
        }
    });
});
</script>
{% endblock %}
